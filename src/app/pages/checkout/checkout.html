<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="bi bi-bag-heart me-2 text-primary"></i>
        üõí Finalizar Compra - Peludinhos PET
      </h2>
      <p class="text-muted mb-4">Estamos quase l√°! Preencha os dados para finalizar a compra dos mimos para seu pet! üêæ</p>
    </div>
  </div>
  <div class="row">
    <!-- Formul√°rio de Checkout -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">
            <i class="bi bi-credit-card me-2"></i>
            Finalizar Compra
          </h4>
        </div>
        <div class="card-body">
          <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">
            <!-- Dados Pessoais -->
            <div class="section-title">
              <h5><i class="bi bi-person-heart me-2"></i>üë§ Dados Pessoais</h5>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="firstName" class="form-label">Nome *</label>
                <input
                  type="text"
                  class="form-control"
                  id="firstName"
                  formControlName="firstName"
                  [class.is-invalid]="isFieldInvalid('firstName')"
                  placeholder="Seu nome"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('firstName')">
                  {{ getFieldError('firstName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="lastName" class="form-label">Sobrenome *</label>
                <input
                  type="text"
                  class="form-control"
                  id="lastName"
                  formControlName="lastName"
                  [class.is-invalid]="isFieldInvalid('lastName')"
                  placeholder="Seu sobrenome"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('lastName')">
                  {{ getFieldError('lastName') }}
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email *</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  formControlName="email"
                  [class.is-invalid]="isFieldInvalid('email')"
                  placeholder="seu@email.com"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
                  {{ getFieldError('email') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">Telefone *</label>
                <input
                  type="tel"
                  class="form-control"
                  id="phone"
                  formControlName="phone"
                  [class.is-invalid]="isFieldInvalid('phone')"
                  placeholder="(11) 99999-9999"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('phone')">
                  {{ getFieldError('phone') }}
                </div>
              </div>
            </div>

            <!-- Endere√ßo de Entrega -->
            <div class="section-title">
              <h5><i class="bi bi-house-heart me-2"></i>üè† Endere√ßo de Entrega</h5>
            </div>
            <div class="mb-3">
              <label for="address" class="form-label">Endere√ßo *</label>
              <input
                type="text"
                class="form-control"
                id="address"
                formControlName="address"
                [class.is-invalid]="isFieldInvalid('address')"
                placeholder="Rua, n√∫mero, complemento"
              >
              <div class="invalid-feedback" *ngIf="isFieldInvalid('address')">
                {{ getFieldError('address') }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="city" class="form-label">Cidade *</label>
                <input
                  type="text"
                  class="form-control"
                  id="city"
                  formControlName="city"
                  [class.is-invalid]="isFieldInvalid('city')"
                  placeholder="Sua cidade"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('city')">
                  {{ getFieldError('city') }}
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <label for="state" class="form-label">Estado *</label>
                <input
                  type="text"
                  class="form-control"
                  id="state"
                  formControlName="state"
                  [class.is-invalid]="isFieldInvalid('state')"
                  placeholder="SP"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('state')">
                  {{ getFieldError('state') }}
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <label for="zipCode" class="form-label">CEP *</label>
                <input
                  type="text"
                  class="form-control"
                  id="zipCode"
                  formControlName="zipCode"
                  [class.is-invalid]="isFieldInvalid('zipCode')"
                  placeholder="00000-000"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('zipCode')">
                  {{ getFieldError('zipCode') }}
                </div>
              </div>
            </div>

            <!-- Dados de Pagamento -->
            <div class="section-title">
              <h5><i class="bi bi-credit-card-heart me-2"></i>üí≥ Dados de Pagamento</h5>
            </div>
            <div class="mb-3">
              <label class="form-label">M√©todo de Pagamento *</label>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="paymentMethod"
                  id="credit"
                  value="credit"
                  formControlName="paymentMethod"
                >
                <label class="form-check-label" for="credit">
                  <i class="bi bi-credit-card me-2"></i>Cart√£o de Cr√©dito
                </label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="paymentMethod"
                  id="debit"
                  value="debit"
                  formControlName="paymentMethod"
                >
                <label class="form-check-label" for="debit">
                  <i class="bi bi-credit-card-2-front me-2"></i>Cart√£o de D√©bito
                </label>
              </div>
            </div>
            <div class="mb-3">
              <label for="cardName" class="form-label">Nome no Cart√£o *</label>
              <input
                type="text"
                class="form-control"
                id="cardName"
                formControlName="cardName"
                [class.is-invalid]="isFieldInvalid('cardName')"
                placeholder="Nome como est√° no cart√£o"
              >
              <div class="invalid-feedback" *ngIf="isFieldInvalid('cardName')">
                {{ getFieldError('cardName') }}
              </div>
            </div>
            <div class="mb-3">
              <label for="cardNumber" class="form-label">N√∫mero do Cart√£o *</label>
              <input
                type="text"
                class="form-control"
                id="cardNumber"
                formControlName="cardNumber"
                [class.is-invalid]="isFieldInvalid('cardNumber')"
                placeholder="1234 5678 9012 3456"
                maxlength="16"
              >
              <div class="invalid-feedback" *ngIf="isFieldInvalid('cardNumber')">
                {{ getFieldError('cardNumber') }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="expiryDate" class="form-label">Data de Validade *</label>
                <input
                  type="text"
                  class="form-control"
                  id="expiryDate"
                  formControlName="expiryDate"
                  [class.is-invalid]="isFieldInvalid('expiryDate')"
                  placeholder="MM/AA"
                  maxlength="5"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('expiryDate')">
                  {{ getFieldError('expiryDate') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="cvv" class="form-label">CVV *</label>
                <input
                  type="text"
                  class="form-control"
                  id="cvv"
                  formControlName="cvv"
                  [class.is-invalid]="isFieldInvalid('cvv')"
                  placeholder="123"
                  maxlength="4"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('cvv')">
                  {{ getFieldError('cvv') }}
                </div>
              </div>
            </div>

            <!-- Bot√µes -->
            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-outline-secondary" (click)="goBack()">
                <i class="bi bi-arrow-left me-2"></i>üõçÔ∏è Voltar
              </button>
              <button
                type="submit"
                class="btn btn-success"
                [disabled]="checkoutForm.invalid || isSubmitting"
              >
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status"></span>
                <i *ngIf="!isSubmitting" class="bi bi-check-circle me-2"></i>
                {{ isSubmitting ? 'Processando...' : 'üéâ Finalizar Compra' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Resumo do Pedido -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-cart-heart me-2"></i>
              üõí Resumo do Pedido
            </h5>
          </div>
        <div class="card-body">
          <!-- Items do Carrinho -->
          <div class="cart-items">
            <div *ngFor="let item of cartItems" class="cart-item mb-3">
              <div class="d-flex align-items-center">
                <img [src]="item.product.thumbnail" [alt]="item.product.title" class="cart-item-image me-3">
                <div class="flex-grow-1">
                  <h6 class="mb-1">{{ item.product.title }}</h6>
                  <div class="d-flex align-items-center mb-2">
                    <div class="input-group input-group-sm" style="width: 100px;">
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        (click)="updateQuantity(item.product.id, item.quantity - 1)"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                      <input
                        type="number"
                        class="form-control text-center"
                        [value]="item.quantity"
                        readonly
                      >
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        (click)="updateQuantity(item.product.id, item.quantity + 1)"
                      >
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                    <button
                      class="btn btn-sm btn-outline-danger ms-2"
                      (click)="removeItem(item.product.id)"
                      title="Remover item"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  <div class="price-info">
                    <span *ngIf="item.product.discountPercentage > 0" class="text-muted text-decoration-line-through me-2">
                      {{ item.product.price | currency:'BRL':'symbol':'1.2-2' }}
                    </span>
                    <span class="fw-bold text-success">
                      {{ calculateDiscountedPrice(item.product.price, item.product.discountPercentage) | currency:'BRL':'symbol':'1.2-2' }}
                    </span>
                    <small class="text-muted"> x {{ item.quantity }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <hr>

          <!-- Totais -->
          <div class="order-summary">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal ({{ totalItems }} {{ totalItems === 1 ? 'item' : 'itens' }}):</span>
              <span>{{ totalPrice | currency:'BRL':'symbol':'1.2-2' }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Frete:</span>
              <span class="text-success">Gr√°tis</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold fs-5">
              <span>Total:</span>
              <span class="text-success">{{ totalPrice | currency:'BRL':'symbol':'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>